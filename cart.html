<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ | ShopDee</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --sat: env(safe-area-inset-top); --sab: env(safe-area-inset-bottom); }
        body { background-color: #f5f5f5; padding-top: calc(60px + var(--sat)); padding-bottom: calc(40px + var(--sab)); font-family: 'Kanit', sans-serif; }
        header { height: calc(60px + var(--sat)); padding-top: var(--sat); }
    </style>
</head>
<body>
    <header class="fixed top-0 left-0 w-full bg-white z-50 border-b flex items-center px-4 shadow-sm">
        <button onclick="location.href='index.html'" class="w-10 h-10 flex items-center justify-center bg-gray-100 rounded-full active:scale-90 transition">
            <i class="fas fa-chevron-left text-lg"></i>
        </button>
        <h1 class="ml-4 font-bold text-gray-800 text-lg">‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h1>
    </header>

    <main class="container mx-auto max-w-lg p-4">
        <div id="cart-list" class="space-y-3 mb-6">
            <div class="flex justify-center py-20"><i class="fas fa-spinner fa-spin text-[#ee4d2d] text-2xl"></i></div>
        </div>

        <div id="checkout-section" class="bg-white rounded-3xl p-6 shadow-md space-y-5 hidden">
            <div class="flex justify-between items-end border-b pb-4">
                <span class="text-gray-500 font-medium">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</span>
                <span id="cart-total" class="text-3xl font-bold text-[#ee4d2d]">‡∏ø0</span>
            </div>
            
            <div class="space-y-3">
                <p class="text-xs font-bold text-gray-400 uppercase tracking-widest">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</p>
                <input type="text" id="customer-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö" class="w-full border border-gray-100 bg-gray-50 rounded-xl px-4 py-3 outline-none focus:border-[#ee4d2d] transition-all">
                <input type="tel" id="customer-phone" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå" class="w-full border border-gray-100 bg-gray-50 rounded-xl px-4 py-3 outline-none focus:border-[#ee4d2d] transition-all">
                <textarea id="customer-address" rows="2" placeholder="‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤" class="w-full border border-gray-100 bg-gray-50 rounded-xl px-4 py-3 outline-none focus:border-[#ee4d2d] transition-all resize-none"></textarea>
            </div>

            <div class="flex flex-col gap-3 pt-2">
                <button onclick="checkoutWithBeam()" class="w-full bg-blue-600 text-white font-bold py-4 rounded-2xl flex justify-center items-center gap-3 shadow-lg shadow-blue-100 active:scale-95 transition">
                    <i class="fas fa-credit-card text-xl"></i> ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå (QR Payment)
                </button>

                <button onclick="checkoutViaLine()" class="w-full bg-[#06C755]/10 text-[#06C755] font-semibold py-3 rounded-xl flex justify-center items-center gap-2 border border-[#06C755]/20 active:scale-95 transition">
                    <i class="fab fa-line text-2xl"></i> ‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ú‡πà‡∏≤‡∏ô LINE
                </button>
            </div>
        </div>
    </main>

    <div id="qr-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="closeQR()"></div>
        <div class="bg-white rounded-3xl p-8 max-w-xs w-full relative z-[110] text-center shadow-2xl">
            <h3 class="text-xl font-bold text-gray-800 mb-4">‡∏™‡πÅ‡∏Å‡∏ô‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h3>
            <div class="bg-gray-100 p-2 rounded-2xl mb-4">
                <img id="qr-image" src="" alt="PromptPay QR" class="w-full rounded-xl">
            </div>
            <p class="text-sm text-gray-500 mb-6 font-light">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏Ñ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏≥‡πÑ‡∏õ‡∏™‡πÅ‡∏Å‡∏ô‡πÉ‡∏ô‡πÅ‡∏≠‡∏õ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô</p>
            <button onclick="closeQR()" class="w-full py-4 bg-gray-100 text-gray-600 font-bold rounded-2xl active:scale-95 transition">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>
        </div>
    </div>

    <script>
        const LINE_ID = "@888fsncq";
        const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRa5jSPp8xIyhJfaq_rwMEWzPCUpjDnUfOnk476Ce80gfcUUdxCVVIsW3YYmFZe4hsKsB6PdCyNESBq/pub?output=csv";
        let products = [];
        let finalAmount = 0;

        async function loadCart() {
            const cart = JSON.parse(localStorage.getItem('cart') || '{}');
            if (Object.keys(cart).length === 0) {
                document.getElementById('cart-list').innerHTML = `
                    <div class="text-center py-20 text-gray-400">
                        <i class="fas fa-shopping-basket text-5xl mb-4 opacity-20"></i>
                        <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</p>
                    </div>`;
                document.getElementById('checkout-section').classList.add('hidden');
                return;
            }

            try {
                const res = await fetch(SHEET_URL);
                const data = await res.text();
                const rows = data.split(/\r?\n/).slice(1);
                products = rows.filter(r => r.trim() !== "").map(r => {
                    const parts = r.match(/(".*?"|[^,]+)(?=\s*,|\s*$)/g);
                    const clean = parts.map(p => p.replace(/^"|"$/g, '').trim());
                    return { id: clean[0], name: clean[1], price: parseFloat(clean[2]), images: clean[6].split("|") };
                });

                let html = '', subTotal = 0, tempehPieces = 0;
                
                for (const [id, qty] of Object.entries(cart)) {
                    const p = products.find(prod => prod.id == id);
                    if (p) {
                        let itemTotal = 0;
                        const quantity = parseInt(qty);

                        // ‚ú® Logic ‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ‡πÄ‡∏ï‡πá‡∏°‡πÄ‡∏õ (ID: 1)
                        if (id === "1") {
                            if (quantity === 3) itemTotal = 100; // ‡πÇ‡∏õ‡∏£ 3 ‡∏ä‡∏¥‡πâ‡∏ô 100.-
                            else if (quantity === 6) itemTotal = 200; // ‡πÇ‡∏õ‡∏£ 6 ‡∏ä‡∏¥‡πâ‡∏ô 200.-
                            else itemTotal = p.price * quantity;
                            tempehPieces += (quantity * 1);
                        } else if (id === "2") {
                            itemTotal = p.price * quantity;
                            tempehPieces += (quantity * 3);
                        } else if (id === "3") {
                            itemTotal = p.price * quantity;
                            tempehPieces += (quantity * 6);
                        } else {
                            itemTotal = p.price * quantity;
                        }

                        subTotal += itemTotal;
                        html += `
                            <div class="bg-white p-4 rounded-2xl flex items-center gap-4 shadow-sm border border-gray-50">
                                <img src="${p.images[0]}" class="w-16 h-16 object-cover rounded-xl">
                                <div class="flex-1">
                                    <div class="text-sm font-medium text-gray-800 line-clamp-1">${p.name}</div>
                                    <div class="text-[#ee4d2d] font-bold">‡∏ø${itemTotal.toLocaleString()}</div>
                                    <div class="text-[10px] text-gray-400">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${quantity} ‡∏ä‡∏¥‡πâ‡∏ô</div>
                                </div>
                                <div class="flex items-center gap-3 bg-gray-50 rounded-full px-2 py-1">
                                    <button onclick="changeQty('${id}', -1)" class="w-7 h-7 flex items-center justify-center bg-white rounded-full shadow-sm text-gray-400"><i class="fas fa-minus text-xs"></i></button>
                                    <span class="text-sm font-bold text-gray-700 min-w-[20px] text-center">${quantity}</span>
                                    <button onclick="changeQty('${id}', 1)" class="w-7 h-7 flex items-center justify-center bg-white rounded-full shadow-sm text-[#ee4d2d]"><i class="fas fa-plus text-xs"></i></button>
                                </div>
                            </div>
                        `;
                    }
                }

                // ‚ú® Logic ‡∏Ñ‡πà‡∏≤‡∏à‡∏±‡∏î‡∏™‡πà‡∏á: ‡∏ñ‡πâ‡∏≤‡∏™‡∏±‡πà‡∏á 6 ‡∏ä‡∏¥‡πâ‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ ‡∏™‡πà‡∏á‡∏ü‡∏£‡∏µ!
                let shipping = (tempehPieces > 0 && tempehPieces < 6) ? 35 : 0;
                if (shipping > 0) {
                    html += `<div class="bg-orange-50 p-4 rounded-2xl flex justify-between items-center text-orange-600">
                        <div class="flex items-center gap-2 font-bold text-xs"><i class="fas fa-truck"></i> ‡∏Ñ‡πà‡∏≤‡∏à‡∏±‡∏î‡∏™‡πà‡∏á (‡πÄ‡∏ï‡πá‡∏°‡πÄ‡∏õ < 6 ‡∏ä‡∏¥‡πâ‡∏ô)</div>
                        <span class="font-bold text-sm">‡∏ø${shipping}</span>
                    </div>`;
                } else if (tempehPieces >= 6) {
                    html += `<div class="bg-green-50 p-4 rounded-2xl flex justify-between items-center text-green-600">
                        <div class="flex items-center gap-2 font-bold text-xs"><i class="fas fa-shipping-fast"></i> ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô: ‡∏™‡πà‡∏á‡∏ü‡∏£‡∏µ!</div>
                        <span class="font-bold text-sm">‡∏ø0</span>
                    </div>`;
                }

                finalAmount = subTotal + shipping;
                document.getElementById('cart-list').innerHTML = html;
                document.getElementById('cart-total').innerText = '‡∏ø' + finalAmount.toLocaleString();
                document.getElementById('checkout-section').classList.remove('hidden');
            } catch (e) { console.error(e); }
        }

        function changeQty(id, delta) {
            let cart = JSON.parse(localStorage.getItem('cart') || '{}');
            cart[id] = (parseInt(cart[id]) || 0) + delta;
            if (cart[id] <= 0) delete cart[id];
            localStorage.setItem('cart', JSON.stringify(cart));
            loadCart();
        }

        async function checkoutWithBeam() {
            const name = document.getElementById('customer-name').value;
            const phone = document.getElementById('customer-phone').value;
            if (!name || !phone) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£');

            // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Beam Checkout (‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô)
            const cart = JSON.parse(localStorage.getItem('cart') || '{}');
            const items = [];
            let currentSub = 0;
            let tp = 0;

            for (const [id, qty] of Object.entries(cart)) {
                const p = products.find(prod => prod.id == id);
                let price = p.price;
                if (id === "1") {
                    if (qty == 3) price = 100 / 3;
                    else if (qty == 6) price = 200 / 6;
                    tp += (qty * 1);
                } else if (id === "2") tp += (qty * 3);
                else if (id === "3") tp += (qty * 6);
                
                items.push({ name: p.name, quantity: parseInt(qty), price: Math.round(price * 100) });
            }

            let sf = (tp > 0 && tp < 6) ? 35 : 0;
            if (sf > 0) items.push({ name: "‡∏Ñ‡πà‡∏≤‡∏à‡∏±‡∏î‡∏™‡πà‡∏á", quantity: 1, price: 3500 });

            try {
                const res = await fetch('/api/checkout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        amount: Math.round(finalAmount * 100),
                        currency: "THB",
                        referenceId: "ORDER-" + Date.now(),
                        items: items,
                        paymentMethod: { 
                            paymentMethodType: "QR_PROMPT_PAY", 
                            qrPromptPay: { expiryTime: new Date(Date.now() + 3600000).toISOString() } 
                        }
                    })
                });
                const result = await res.json();
                if (result.actionRequired === "ENCODED_IMAGE") {
                    document.getElementById('qr-image').src = "data:image/png;base64," + result.encodedImage.imageBase64Encoded;
                    document.getElementById('qr-modal').classList.remove('hidden');
                }
            } catch (e) { alert("‡∏£‡∏∞‡∏ö‡∏ö‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á"); }
        }

        function closeQR() { document.getElementById('qr-modal').classList.add('hidden'); }

        function checkoutViaLine() {
            const name = document.getElementById('customer-name').value;
            const phone = document.getElementById('customer-phone').value;
            const address = document.getElementById('customer-address').value;
            if (!name || !phone) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');

            const cart = JSON.parse(localStorage.getItem('cart') || '{}');
            let msg = `üõí *‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤*\n----------------\n`, sub = 0, tp = 0;
            for (const [id, qty] of Object.entries(cart)) {
                const p = products.find(prod => prod.id == id);
                let itemP = 0;
                if (id == "1") {
                    if (qty == 3) itemP = 100; else if (qty == 6) itemP = 200; else itemP = p.price * qty;
                    tp += (qty * 1);
                } else if (id == "2") { itemP = p.price * qty; tp += (qty * 3); }
                else if (id == "3") { itemP = p.price * qty; tp += (qty * 6); }
                else itemP = p.price * qty;

                msg += `- ${p.name} (x${qty}): ${itemP}.- \n`;
                sub += itemP;
            }
            let sf = (tp > 0 && tp < 6) ? 35 : 0;
            msg += `----------------\nüì¶ ‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á: ${sf} ‡∏ö‡∏≤‡∏ó\nüí∞ ‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥: ${(sub + sf).toLocaleString()} ‡∏ö‡∏≤‡∏ó\nüë§ ${name}\nüìû ${phone}\nüìç ${address}`;
            window.location.href = `https://line.me/R/oaMessage/${LINE_ID}/?${encodeURIComponent(msg)}`;
        }

        loadCart();
    </script>
</body>
</html>
