<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ | ShopDee</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --sat: env(safe-area-inset-top); --sab: env(safe-area-inset-bottom); }
        body { background-color: #f5f5f5; padding-top: calc(60px + var(--sat)); padding-bottom: calc(40px + var(--sab)); font-family: 'Kanit', sans-serif; }
        header { height: calc(60px + var(--sat)); padding-top: var(--sat); }
    </style>
</head>
<body>
    <header class="fixed top-0 left-0 w-full bg-white z-50 border-b flex items-center px-4 shadow-sm">
        <button onclick="location.href='index.html'" class="w-10 h-10 flex items-center justify-center bg-gray-100 rounded-full active:scale-90 transition">
            <i class="fas fa-chevron-left text-lg"></i>
        </button>
        <h1 class="ml-4 font-bold text-gray-800 text-lg">‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h1>
    </header>

    <main class="container mx-auto max-w-lg p-4">
        <div id="cart-list" class="space-y-3 mb-6">
            <div class="flex justify-center py-20"><i class="fas fa-spinner fa-spin text-[#ee4d2d] text-2xl"></i></div>
        </div>

        <div id="checkout-section" class="bg-white rounded-3xl p-6 shadow-md space-y-5 hidden">
            <div class="flex justify-between items-end border-b pb-4">
                <span class="text-gray-500 font-medium">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á</span>
                <span id="cart-total" class="text-3xl font-bold text-[#ee4d2d]">‡∏ø0</span>
            </div>
            
            <div class="space-y-3">
                <input type="text" id="customer-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö" class="w-full border border-gray-100 bg-gray-50 rounded-xl px-4 py-3 outline-none focus:border-[#ee4d2d]">
                <input type="tel" id="customer-phone" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå" class="w-full border border-gray-100 bg-gray-50 rounded-xl px-4 py-3 outline-none focus:border-[#ee4d2d]">
                <textarea id="customer-address" rows="2" placeholder="‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á" class="w-full border border-gray-100 bg-gray-50 rounded-xl px-4 py-3 outline-none focus:border-[#ee4d2d] resize-none"></textarea>
            </div>

            <div class="bg-blue-50/50 rounded-2xl p-4 flex items-center gap-3 border border-blue-100">
                <img src="https://upload.wikimedia.org/wikipedia/commons/5/56/Flag_of_Laos.svg" class="w-6 shadow-sm rounded-sm">
                <div class="text-[10px] text-blue-700 leading-tight">
                    <p class="font-bold">‡∫™‡∫∞‡ªÅ‡∫Å‡∫ô‡∫à‡ªà‡∫≤‡∫ç‡∫î‡ªâ‡∫ß‡∫ç‡ªÅ‡∫≠‡∫±‡∫ö‡∫ó‡∫∞‡∫ô‡∫≤‡∫Ñ‡∫≤‡∫ô‡∫•‡∫≤‡∫ß‡ªÑ‡∫î‡ªâ</p>
                    <p>‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô‡∏à‡πà‡∏≤‡∏¢‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏≠‡∏õ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏•‡∏≤‡∏ß‡∏ó‡∏∏‡∏Å‡πÅ‡∏´‡πà‡∏á</p>
                </div>
            </div>

            <div class="flex flex-col gap-3 pt-2">
                <button onclick="checkoutWithBeam()" class="w-full bg-blue-600 text-white font-bold py-4 rounded-2xl flex justify-center items-center gap-3 shadow-lg active:scale-95 transition">
                    <i class="fas fa-credit-card text-xl"></i> ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå (QR Payment)
                </button>
                <button onclick="checkoutViaLine()" class="w-full bg-[#06C755]/10 text-[#06C755] font-semibold py-3 rounded-xl flex justify-center items-center gap-2 border border-[#06C755]/20 active:scale-95 transition">
                    <i class="fab fa-line text-2xl"></i> ‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ú‡πà‡∏≤‡∏ô LINE
                </button>
            </div>
        </div>
    </main>

    <script>
        const LINE_ID = "@888fsncq";
        const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRa5jSPp8xIyhJfaq_rwMEWzPCUpjDnUfOnk476Ce80gfcUUdxCVVIsW3YYmFZe4hsKsB6PdCyNESBq/pub?output=csv";
        let products = [], finalAmount = 0;

        async function loadCart() {
            const cart = JSON.parse(localStorage.getItem('cart') || '{}');
            if (Object.keys(cart).length === 0) {
                document.getElementById('cart-list').innerHTML = `<div class="text-center py-20 text-gray-400"><p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</p></div>`;
                document.getElementById('checkout-section').classList.add('hidden');
                return;
            }
            try {
                const res = await fetch(`${SHEET_URL}&t=${Date.now()}`);
                const data = await res.text();
                const rows = data.split(/\r?\n/).slice(1);
                products = rows.filter(r => r.trim() !== "").map(r => {
                    const parts = r.match(/(".*?"|[^,]+)(?=\s*,|\s*$)/g);
                    const clean = parts.map(p => p.replace(/^"|"$/g, '').trim());
                    return { id: clean[0], name: clean[1], price: parseFloat(clean[2]), images: clean[6].split("|") };
                });

                let html = '', subTotal = 0, tempehPieces = 0;
                
                for (const [id, qty] of Object.entries(cart)) {
                    const p = products.find(prod => prod.id == id);
                    if (p) {
                        let itemTotal = 0, quantity = parseInt(qty);
                        
                        // ‚ú® ‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô (3 ‡∏ä‡∏¥‡πâ‡∏ô 100 / 6 ‡∏ä‡∏¥‡πâ‡∏ô 200)
                        if (id === "1") {
                            if (quantity === 3) itemTotal = 100;
                            else if (quantity === 6) itemTotal = 200;
                            else itemTotal = p.price * quantity;
                            tempehPieces += quantity;
                        } else {
                            itemTotal = p.price * quantity;
                            if (id === "2") tempehPieces += (quantity * 3);
                            if (id === "3") tempehPieces += (quantity * 6);
                        }
                        
                        subTotal += itemTotal;
                        const displayName = (id === "1") ? `‡πÄ‡∏ï‡πá‡∏°‡πÄ‡∏õ ${quantity} ‡∏ä‡∏¥‡πâ‡∏ô` : p.name;

                        html += `
                            <div class="bg-white p-4 rounded-2xl flex items-center gap-4 shadow-sm border border-gray-50">
                                <img src="${p.images[0]}" class="w-16 h-16 object-cover rounded-xl">
                                <div class="flex-1 min-w-0">
                                    <div class="text-sm font-bold text-gray-800 truncate">${displayName}</div>
                                    <div class="text-[#ee4d2d] font-bold">‡∏ø${itemTotal.toLocaleString()}</div>
                                </div>
                                <div class="flex items-center gap-3 bg-gray-50 rounded-full px-2 py-1">
                                    <button onclick="changeQty('${id}', -1)" class="w-7 h-7 flex items-center justify-center bg-white rounded-full shadow-sm text-gray-400"><i class="fas fa-minus text-xs"></i></button>
                                    <span class="text-sm font-bold text-gray-700 text-center min-w-[20px]">${quantity}</span>
                                    <button onclick="changeQty('${id}', 1)" class="w-7 h-7 flex items-center justify-center bg-white rounded-full shadow-sm text-[#ee4d2d]"><i class="fas fa-plus text-xs"></i></button>
                                </div>
                            </div>`;
                    }
                }

                // ‚ú® ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á‡πÅ‡∏•‡∏∞‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏™‡πà‡∏á‡∏ü‡∏£‡∏µ
                let shipping = (tempehPieces > 0 && tempehPieces < 6) ? 35 : 0;
                if (tempehPieces >= 6) {
                    html += `<div class="bg-green-50 p-4 rounded-2xl flex justify-between items-center text-green-600 border border-green-100 font-bold text-xs">
                        <span><i class="fas fa-shipping-fast"></i> ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏™‡∏±‡πà‡∏á‡∏Ñ‡∏£‡∏ö 6 ‡∏ä‡∏¥‡πâ‡∏ô: ‡∏™‡πà‡∏á‡∏ü‡∏£‡∏µ!</span>
                        <span>‡∏ø0</span>
                    </div>`;
                } else if (shipping > 0) {
                    html += `<div class="bg-blue-50 p-4 rounded-2xl flex justify-between items-center text-blue-600 border border-blue-100 font-bold text-xs">
                        <span><i class="fas fa-truck"></i> ‡∏Ñ‡πà‡∏≤‡∏à‡∏±‡∏î‡∏™‡πà‡∏á (‡∏≠‡∏µ‡∏Å ${6-tempehPieces} ‡∏ä‡∏¥‡πâ‡∏ô‡∏™‡πà‡∏á‡∏ü‡∏£‡∏µ)</span>
                        <span>‡∏ø${shipping}</span>
                    </div>`;
                }

                finalAmount = subTotal + shipping;
                document.getElementById('cart-list').innerHTML = html;
                document.getElementById('cart-total').innerText = '‡∏ø' + finalAmount.toLocaleString();
                document.getElementById('checkout-section').classList.remove('hidden');
            } catch (e) { console.error(e); }
        }

        function changeQty(id, delta) {
            let cart = JSON.parse(localStorage.getItem('cart') || '{}');
            cart[id] = (parseInt(cart[id]) || 0) + delta;
            if (cart[id] <= 0) delete cart[id];
            localStorage.setItem('cart', JSON.stringify(cart));
            loadCart();
        }

        async function checkoutWithBeam() { /* API Logic */ }
        function checkoutViaLine() {
            const name = document.getElementById('customer-name').value;
            const phone = document.getElementById('customer-phone').value;
            const address = document.getElementById('customer-address').value;
            if (!name || !phone) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
            const cart = JSON.parse(localStorage.getItem('cart') || '{}');
            let msg = `üõí *‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤*\n----------------\n`, sub = 0, tp = 0;
            for (const [id, qty] of Object.entries(cart)) {
                const p = products.find(prod => prod.id == id);
                let itemP = 0;
                if (id == "1") {
                    if (qty == 3) itemP = 100; else if (qty == 6) itemP = 200; else itemP = p.price * qty;
                    tp += (qty * 1);
                } else {
                    itemP = p.price * qty;
                    if (id == "2") tp += (qty * 3);
                    if (id == "3") tp += (qty * 6);
                }
                msg += `- ${id=="1"?'‡πÄ‡∏ï‡πá‡∏°‡πÄ‡∏õ '+qty+' ‡∏ä‡∏¥‡πâ‡∏ô':p.name}: ${itemP}.- \n`;
                sub += itemP;
            }
            let sf = (tp > 0 && tp < 6) ? 35 : 0;
            msg += `----------------\nüì¶ ‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á: ${sf} ‡∏ö‡∏≤‡∏ó\nüí∞ ‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥: ${(sub + sf).toLocaleString()} ‡∏ö‡∏≤‡∏ó\nüë§ ${name}\nüìû ${phone}\nüìç ${address}`;
            window.location.href = `https://line.me/R/oaMessage/${LINE_ID}/?${encodeURIComponent(msg)}`;
        }

        loadCart();
    </script>
</body>
</html>
