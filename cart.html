<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ | ShopDee</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --sat: env(safe-area-inset-top); --sab: env(safe-area-inset-bottom); }
        body { background-color: #f8f9fa; padding-top: calc(60px + var(--sat)); padding-bottom: calc(40px + var(--sab)); font-family: 'Kanit', sans-serif; }
        header { height: calc(60px + var(--sat)); padding-top: var(--sat); }
        .cart-card { transition: all 0.2s ease; }
        .cart-card:active { transform: scale(0.98); }
    </style>
</head>
<body>
    <header class="fixed top-0 left-0 w-full bg-white z-50 border-b flex items-center px-4 shadow-sm">
        <button onclick="location.href='index.html'" class="w-10 h-10 flex items-center justify-center bg-gray-50 rounded-full active:scale-90 transition">
            <i class="fas fa-chevron-left text-lg text-gray-600"></i>
        </button>
        <h1 class="ml-4 font-bold text-gray-800 text-lg">‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h1>
    </header>

    <main class="container mx-auto max-w-lg p-4">
        <div id="cart-list" class="space-y-3 mb-6">
            <div class="flex justify-center py-20"><i class="fas fa-spinner fa-spin text-[#ee4d2d] text-2xl"></i></div>
        </div>

        <div id="checkout-section" class="bg-white rounded-[32px] p-6 shadow-sm border border-gray-100 space-y-6 hidden">
            <div class="flex justify-between items-end border-b border-gray-50 pb-5">
                <span class="text-gray-400 text-sm font-medium">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á</span>
                <span id="cart-total" class="text-3xl font-extrabold text-[#ee4d2d]">‡∏ø0</span>
            </div>
            
            <div class="space-y-3">
                <p class="text-[10px] font-bold text-gray-400 uppercase tracking-[0.2em] ml-1">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</p>
                <input type="text" id="customer-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö" class="w-full bg-gray-50 rounded-2xl px-5 py-4 outline-none focus:ring-2 focus:ring-[#ee4d2d]/10 focus:bg-white border border-transparent focus:border-[#ee4d2d]/20 transition-all text-sm">
                <input type="tel" id="customer-phone" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå" class="w-full bg-gray-50 rounded-2xl px-5 py-4 outline-none focus:ring-2 focus:ring-[#ee4d2d]/10 focus:bg-white border border-transparent focus:border-[#ee4d2d]/20 transition-all text-sm">
                <textarea id="customer-address" rows="2" placeholder="‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤" class="w-full bg-gray-50 rounded-2xl px-5 py-4 outline-none focus:ring-2 focus:ring-[#ee4d2d]/10 focus:bg-white border border-transparent focus:border-[#ee4d2d]/20 transition-all text-sm resize-none"></textarea>
            </div>

            <div class="space-y-3 pt-2">
                <button onclick="checkoutWithBeam()" class="w-full bg-[#ee4d2d] text-white font-bold py-4 rounded-2xl flex justify-center items-center gap-3 shadow-lg shadow-orange-100 active:scale-[0.97] transition-all">
                    <i class="fas fa-check-circle text-xl"></i> ‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÅ‡∏•‡∏∞‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
                </button>
                <button onclick="checkoutViaLine()" class="w-full bg-white text-[#06C755] font-bold py-3.5 rounded-2xl flex justify-center items-center gap-2 border border-[#06C755]/30 active:scale-[0.97] transition-all text-sm">
                    <i class="fab fa-line text-xl"></i> ‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏ú‡πà‡∏≤‡∏ô LINE
                </button>
            </div>
        </div>
    </main>

    <script>
        const LINE_ID = "@888fsncq";
        const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRa5jSPp8xIyhJfaq_rwMEWzPCUpjDnUfOnk476Ce80gfcUUdxCVVIsW3YYmFZe4hsKsB6PdCyNESBq/pub?output=csv";
        let products = [];
        let finalAmount = 0;

        async function loadCart() {
            const cart = JSON.parse(localStorage.getItem('cart') || '{}');
            if (Object.keys(cart).length === 0) {
                document.getElementById('cart-list').innerHTML = `
                    <div class="text-center py-24 text-gray-300">
                        <i class="fas fa-shopping-basket text-6xl mb-4 opacity-10"></i>
                        <p class="text-sm font-medium">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</p>
                        <button onclick="location.href='index.html'" class="mt-4 text-[#ee4d2d] text-xs font-bold underline">‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
                    </div>`;
                document.getElementById('checkout-section').classList.add('hidden');
                return;
            }

            try {
                const res = await fetch(`${SHEET_URL}&t=${Date.now()}`);
                const data = await res.text();
                const rows = data.split(/\r?\n/).slice(1);
                products = rows.filter(r => r.trim() !== "").map(r => {
                    const parts = r.match(/(".*?"|[^,]+)(?=\s*,|\s*$)/g);
                    const clean = parts.map(p => p.replace(/^"|"$/g, '').trim());
                    return { id: clean[0], name: clean[1], price: parseFloat(clean[2]), images: clean[6].split("|") };
                });

                let html = '', subTotal = 0, tempehPieces = 0;
                
                for (const [id, qty] of Object.entries(cart)) {
                    const p = products.find(prod => prod.id == id);
                    if (p) {
                        let itemTotal = 0;
                        const quantity = parseInt(qty);

                        // ‚ú® Logic ‡∏£‡∏≤‡∏Ñ‡∏≤‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô
                        if (id === "1") {
                            if (quantity === 3) itemTotal = 100;
                            else if (quantity === 6) itemTotal = 200;
                            else itemTotal = p.price * quantity;
                            tempehPieces += quantity;
                        } else {
                            itemTotal = p.price * quantity;
                            if (id === "2") tempehPieces += (quantity * 3);
                            if (id === "3") tempehPieces += (quantity * 6);
                        }

                        subTotal += itemTotal;

                        // ‚ú® ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏™‡∏±‡πâ‡∏ô‡∏•‡∏á‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ç‡∏≠: "‡πÄ‡∏ï‡πá‡∏°‡πÄ‡∏õ [‡∏à‡∏≥‡∏ô‡∏ß‡∏ô] ‡∏ä‡∏¥‡πâ‡∏ô"
                        const displayName = (id === "1") ? `‡πÄ‡∏ï‡πá‡∏°‡πÄ‡∏õ ${quantity} ‡∏ä‡∏¥‡πâ‡∏ô` : p.name;

                        html += `
                            <div class="bg-white p-4 rounded-[24px] flex items-center gap-4 shadow-sm border border-gray-50 cart-card">
                                <img src="${p.images[0]}" class="w-16 h-16 object-cover rounded-2xl shadow-inner bg-gray-50">
                                <div class="flex-1 min-w-0">
                                    <div class="text-[15px] font-bold text-gray-800 truncate">${displayName}</div>
                                    <div class="text-[#ee4d2d] font-black text-lg">‡∏ø${itemTotal.toLocaleString()}</div>
                                </div>
                                <div class="flex items-center gap-3 bg-gray-50 rounded-2xl p-1 border border-gray-100">
                                    <button onclick="changeQty('${id}', -1)" class="w-8 h-8 flex items-center justify-center bg-white rounded-xl shadow-sm text-gray-400 active:bg-gray-100"><i class="fas fa-minus text-[10px]"></i></button>
                                    <span class="text-sm font-bold text-gray-700 min-w-[20px] text-center">${quantity}</span>
                                    <button onclick="changeQty('${id}', 1)" class="w-8 h-8 flex items-center justify-center bg-white rounded-xl shadow-sm text-[#ee4d2d] active:bg-gray-100"><i class="fas fa-plus text-[10px]"></i></button>
                                </div>
                            </div>
                        `;
                    }
                }

                // ‚ú® Logic ‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á‡∏ü‡∏£‡∏µ
                let shipping = (tempehPieces > 0 && tempehPieces < 6) ? 35 : 0;
                if (tempehPieces >= 6) {
                    html += `<div class="bg-green-50 p-4 rounded-2xl flex justify-between items-center text-green-600 border border-green-100">
                        <div class="flex items-center gap-2 font-bold text-xs"><i class="fas fa-shipping-fast"></i> ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏™‡∏±‡πà‡∏á‡∏Ñ‡∏£‡∏ö 6 ‡∏ä‡∏¥‡πâ‡∏ô: ‡∏™‡πà‡∏á‡∏ü‡∏£‡∏µ!</div>
                        <span class="font-bold text-sm">‡∏ø0</span>
                    </div>`;
                } else if (shipping > 0) {
                    html += `<div class="bg-blue-50 p-4 rounded-2xl flex justify-between items-center text-blue-600 border border-blue-100">
                        <div class="flex items-center gap-2 font-bold text-xs"><i class="fas fa-truck"></i> ‡∏Ñ‡πà‡∏≤‡∏à‡∏±‡∏î‡∏™‡πà‡∏á (‡∏≠‡∏µ‡∏Å ${6-tempehPieces} ‡∏ä‡∏¥‡πâ‡∏ô‡∏™‡πà‡∏á‡∏ü‡∏£‡∏µ)</div>
                        <span class="font-bold text-sm">‡∏ø${shipping}</span>
                    </div>`;
                }

                finalAmount = subTotal + shipping;
                document.getElementById('cart-list').innerHTML = html;
                document.getElementById('cart-total').innerText = '‡∏ø' + finalAmount.toLocaleString();
                document.getElementById('checkout-section').classList.remove('hidden');
            } catch (e) { console.error(e); }
        }

        function changeQty(id, delta) {
            let cart = JSON.parse(localStorage.getItem('cart') || '{}');
            cart[id] = (parseInt(cart[id]) || 0) + delta;
            if (cart[id] <= 0) delete cart[id];
            localStorage.setItem('cart', JSON.stringify(cart));
            loadCart();
        }

        function checkoutViaLine() {
            const name = document.getElementById('customer-name').value;
            const phone = document.getElementById('customer-phone').value;
            const address = document.getElementById('customer-address').value;
            if (!name || !phone) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå');

            const cart = JSON.parse(localStorage.getItem('cart') || '{}');
            let msg = `üõí *‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤*\n----------------\n`, sub = 0, tp = 0;
            for (const [id, qty] of Object.entries(cart)) {
                const p = products.find(prod => prod.id == id);
                let itemP = 0;
                if (id == "1") {
                    if (qty == 3) itemP = 100; else if (qty == 6) itemP = 200; else itemP = p.price * qty;
                    tp += (qty * 1);
                } else {
                    itemP = p.price * qty;
                    if (id == "2") tp += (qty * 3);
                    if (id == "3") tp += (qty * 6);
                }
                msg += `- ${id=="1"?'‡πÄ‡∏ï‡πá‡∏°‡πÄ‡∏õ '+qty+' ‡∏ä‡∏¥‡πâ‡∏ô':p.name}: ${itemP}.- \n`;
                sub += itemP;
            }
            let sf = (tp > 0 && tp < 6) ? 35 : 0;
            msg += `----------------\nüì¶ ‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á: ${sf} ‡∏ö‡∏≤‡∏ó\nüí∞ ‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥: ${(sub + sf).toLocaleString()} ‡∏ö‡∏≤‡∏ó\nüë§ ${name}\nüìû ${phone}\nüìç ${address}`;
            window.location.href = `https://line.me/R/oaMessage/${LINE_ID}/?${encodeURIComponent(msg)}`;
        }

        loadCart();
    </script>
</body>
</html>
